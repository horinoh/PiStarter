'CONST #GRP_POLY_PAGE=3
'CONST #GRP_POLY_WIDTH=96
'CONST #GRP_POLY_HEIGHT=96
'CONST #GRP_PPOLY_MARGIN=1
VAR _GRP_POLY_PAGE=3
VAR _GRP_POLY_WIDTH=96
VAR _GRP_POLY_HEIGHT=96
VAR _GRP_PPOLY_MARGIN=1

'CONST #X0=0:CONST #Y0=1
'CONST #X1=2:CONST #Y1=3
'CONST #X2=4:CONST #Y3=5
'CONST #NX=6:CONST #NY=7
VAR _X0=0,_Y0=1
VAR _X1=2,_Y1=3
VAR _X2=4,_Y2=5
VAR _NX=6,_NY=7

'COMMON DEF GRP_POLY_PAGE() RETURN #GRP_POLY_PAGE END
'COMMON DEF GRP_POLY_WIDTH() RETURN #GRP_POLY_WIDTH END
'COMMON DEF GRP_POLY_HEIGHT() RETURN #GRP_POLY_HEIGHT END
'COMMON DEF GRP_POLY_MARGIN() RETURN #GRP_PPOLY_MARGIN END
COMMON DEF GRP_POLY_PAGE() RETURN _GRP_POLY_PAGE END
COMMON DEF GRP_POLY_WIDTH() RETURN _GRP_POLY_WIDTH END
COMMON DEF GRP_POLY_HEIGHT() RETURN _GRP_POLY_HEIGHT END
COMMON DEF GRP_POLY_MARGIN() RETURN _GRP_PPOLY_MARGIN END

'COMMON DEF GRP_POLY_ROW(I%) RETURN I% DIV (#GRPWIDTH DIV GRP_POLY_WIDTH()) END
'COMMON DEF GRP_POLY_COLUMN(I%) RETURN I% MOD (#GRPWIDTH DIV GRP_POLY_WIDTH()) END
VAR _GRPWIDTH=1280
VAR _GRPHEIGHT=1024
COMMON DEF GRP_POLY_ROW(I%) RETURN I% DIV (_GRPWIDTH DIV GRP_POLY_WIDTH()) END
COMMON DEF GRP_POLY_COLUMN(I%) RETURN I% MOD (_GRPWIDTH DIV GRP_POLY_WIDTH()) END

DEF VERIFY_DRAWING_RANGE(I%)
VAR MXROW=GRP_POLY_ROW(i%)
 VAR MXY=MXROW*GRP_POLY_HEIGHT()
 'VAR MXCOL=#GRPWIDTH DIV GRP_POLY_WIDTH()
 VAR MXCOL=_GRPWIDTH DIV GRP_POLY_WIDTH()
 VAR MXX=MXCOL*GRP_POLY_WIDTH()
 '?"POLY SIZE=";
 '?GRP_POLY_WIDTH();
 '?"x";
 '?GRP_POLY_HEIGHT()
 '?"COLUMNxROW=";
 '?MXCOL;
 '?"x";
 '?MXROW
 'IF MXY>#GRPHEIGHT THEN
 IF MXY>_GRPHEIGHT THEN 
  COLOR #YELLOW
  ?"REQUIRED SIZE=";
  ?MXX;
  ?"x";
  ?MXY
  ?"LIMIT SIZE=";
  '?#GRPWIDTH;
  ?_GRPWIDTH;
  ?"x";
  '?#GRPHEIGHT
  ?_GRPHEIGHT
  COLOR #WHITE
  RETURN #FALSE
 ENDIF
 RETURN #TRUE
END

COMMON DEF GRP_DRAW_TRIANGLES PG%,W%,H%,MGN%,COL%
 'GTARGET PG%
 GPAGE 0,PG%

 GCLS

 VAR WMGN%=W%-MGN%
 VAR HMGN%=H%-MGN%
 VAR I%
 
 IF !VERIFY_DRAWING_RANGE(WMGN%-1) THEN RETURN ENDIF

 FOR I%=0 TO WMGN%-1
  VAR OFX%=GRP_POLY_COLUMN(I%)*GRP_POLY_WIDTH()
  VAR OFY%=GRP_POLY_ROW(I%)*GRP_POLY_HEIGHT()
  GTRI OFX%+I%,OFY%, OFX%,OFY%+HMGN%, OFX%+WMGN%,OFY%+HMGN%, COL%
 NEXT
END

COMMON DEF SPPOLY_SETUP
 ' SPRITE TEMPLATE
 VAR DID%=0
 SPDEF DID%, 0,0, GRP_POLY_WIDTH(),GRP_POLY_HEIGHT(), 0,GRP_POLY_HEIGHT()

 SPPAGE GRP_POLY_PAGE()
 ' SPRITE MAX (R:[0,511],4:[0,4095])
 FOR I%=0 TO 10'511
  SPSET I%,DID%
  SPFUNC I%,"SPPOLY_DRAW"
  SPHIDE I%
 NEXT
END

COMMON DEF SPPOLY_CLEAR
 FOR I%=0 TO 10'511
  SPHIDE I%
 NEXT
END

COMMON DEF SPPOLY_DRAW
 'VAR I%=CALLIDX()
 VAR I%=CALLIDX
 
 VAR A[2]'=[SPVAR(I%,#X0), SPVAR(I%,#Y0)]
 VAR B[2]'=[SPVAR(I%,#X1), SPVAR(I%,#Y1)]
 VAR C[2]'=[SPVAR(I%,#X2), SPVAR(I%,#Y2)]
 A[0]=SPVAR(I%,_X0):A[1]=SPVAR(I%,_Y0)
 B[0]=SPVAR(I%,_X1):B[1]=SPVAR(I%,_Y1)
 C[0]=SPVAR(I%,_X2):C[1]=SPVAR(I%,_Y2)

 VAR AB[2],BC[2],CA[2]
 'ARYOP #AOPSUB,AB,B,A
 'ARYOP #AOPSUB,BC,C,B
 'ARYOP #AOPSUB,CA,A,C
 VAR J%
 FOR J%=0 TO LEN(AB)-1 AB[J%]=B[J%]-A[J%] NEXT
 FOR J%=0 TO LEN(BC)-1 BC[J%]=C[J%]-B[J%] NEXT
 FOR J%=0 TO LEN(CA)-1 CA[J%]=A[J%]-C[J%] NEXT

 VAR SIDES[3]'=[DOT(AB.AB),DOT(BC,BC),DOT(CA,CA)]
 SIDES[0]=DOT(AB,AB):SIDES[1]=DOT(BC,BC):SIDES[2]=DOT(CA,CA)
 VAR MX=MAX(SIDES)
 IF MX==SIDES[1] THEN
  'A[0]=SPVAR(I%,#X1):A[1]=SPVAR(I%,#Y1)
  'B[0]=SPVAR(I%,#X2):B[1]=SPVAR(I%,#Y2) 
  'C[0]=SPVAR(I%,#X0):C[1]=SPVAR(I%,#Y0)
  A[0]=SPVAR(I%,_X1):A[1]=SPVAR(I%,_Y1)
  B[0]=SPVAR(I%,_X2):B[1]=SPVAR(I%,_Y2) 
  C[0]=SPVAR(I%,_X0):C[1]=SPVAR(I%,_Y0)
  COPY AB,BC
 ELSEIF MAX==SIDES[2] THEN
  'A[0]=SPVAR(I%,#X2):A[1]=SPVAR(I%,#Y2)
  'B[0]=SPVAR(I%,#X0):B[1]=SPVAR(I%,#Y0) 
  'C[0]=SPVAR(I%,#X1):C[1]=SPVAR(I%,#Y1)
  A[0]=SPVAR(I%,_X2):A[1]=SPVAR(I%,_Y2)
  B[0]=SPVAR(I%,_X0):B[1]=SPVAR(I%,_Y0) 
  C[0]=SPVAR(I%,_X1):C[1]=SPVAR(I%,_Y1)
  COPY AB,CA
 ENDIF

 'VAR CP[2]
 'VAR T=CLOSEST_POINT_LINE(CP,C,A,B)

 ?i%
 SPOFS I%,320,I%*GRP_POLY_HEIGHT()*0.5
 
 VAR AID%=(GRP_POLY_WIDTH()-GRP_POLY_MARGIN()-1)/2
 'VAR AID%=T*GRP_POLY_WIDTH()
 SPANIM I%,"UV",1,GRP_POLY_COLUMN(AID%)*GRP_POLY_WIDTH(),GRP_POLY_ROW(AID%)*GRP_POLY_HEIGHT()

 SPROT I%,DEG(ATAN(1,1))

 SPSCALE I%,0.5,0.5

 SPCOLOR I%,#YELLOW

 SPSHOW I%
END
